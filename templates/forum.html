{% extends "base.html" %}

{% block title %}Forum{% endblock %}

{% block content %}
    <h1>Whack-a-Mole Forum</h1>
    <div id="chat-container">
        <div id="chat-messages"></div>
        <form id="chat-form">
            <input type="text" id="chat-input" placeholder="Type your message..." required>
            <button type="submit">Send</button>
        </form>
    </div>
    <div id="leaderboard-container">
        <h2>Leaderboard</h2>
        <div id="leaderboard-buttons">
            <button onclick="showLeaderboard('all')">All</button>
            <button onclick="showLeaderboard('easy')">Easy</button>
            <button onclick="showLeaderboard('medium')">Medium</button>
            <button onclick="showLeaderboard('hard')">Hard</button>
        </div>
        <div id="leaderboard-content"></div>
    </div>
{% endblock %}

{% block scripts %}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script>
        const chatMessages = document.getElementById('chat-messages');
        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('chat-input');

        // Event Source for real-time chat updates
        const eventSource = new EventSource("{{ url_for('get_messages') }}");
        eventSource.onmessage = function(event) {
            const messages = JSON.parse(event.data);
            messages.forEach(message => {
                const messageElement = document.createElement('div');
                messageElement.innerHTML = `<strong>${message.username}:</strong> ${message.message}`;
                chatMessages.appendChild(messageElement);
            });
            chatMessages.scrollTop = chatMessages.scrollHeight;
        };

        chatForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const message = chatInput.value;
            fetch("{{ url_for('send_message') }}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `message=${encodeURIComponent(message)}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    chatInput.value = '';
                }
            });
        });

        function showLeaderboard(difficulty) {
            fetch(`/leaderboard/${difficulty}`)
                .then(response => response.json())
                .then(data => {
                    let html = `<h3>${difficulty.charAt(0).toUpperCase() + difficulty.slice(1)} Leaderboard</h3>
                                <table>
                                    <tr>
                                        <th>Rank</th>
                                        <th>Player</th>
                                        <th>Score</th>
                                        <th>Date</th>
                                    </tr>`;
                    data.forEach((score, index) => {
                        html += `<tr>
                                    <td>${index + 1}</td>
                                    <td>${score.username}</td>
                                    <td>${score.score}</td>
                                    <td>${score.date}</td>
                                </tr>`;
                    });
                    html += '</table>';
                    document.getElementById('leaderboard-content').innerHTML = html;
                })
                .catch(error => console.error('Error:', error));
        }

        // Show 'All' leaderboard by default
        showLeaderboard('all');
    </script>
{% endblock %}
